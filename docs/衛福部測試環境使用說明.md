# 衛福部 SMART on FHIR 測試環境使用說明

## ✅ 資料匯入狀態

已成功匯入 5 位測試病患的完整資料到衛福部 FHIR Server：

- ✅ 5 位病患基本資料（Patient）
- ✅ 5 筆生命徵象與檢驗資料（Observation）
- ✅ 5 筆診斷記錄（Condition）
- ✅ 5 筆用藥處方（MedicationRequest）

## 🌐 測試環境資訊

### FHIR Server URL
```
https://thas.mohw.gov.tw/v/r4/sim/WzIsIiIsIiIsIkFVVE8iLDAsMCwwLCIiLCIiLCIiLCIiLCIiLCIiLCIiLDAsMSwiIl0/fhir
```

### Patient Viewer（病患瀏覽器）
```
https://thas.mohw.gov.tw/patient-browser/
```

## 🚀 測試方法

### 方法 1: 使用 Patient Viewer（推薦）

1. **開啟 Patient Viewer**
   ```
   https://thas.mohw.gov.tw/patient-browser/
   ```

2. **設定 Launch URL**
   - 在 "Launch URL" 欄位輸入：
     ```
     https://localhost:5001/launch.html
     ```

3. **選擇測試模式**
   - 選擇 **"EHR_LAUNCH"** 模式

4. **選擇測試病患**

   我們匯入的 5 位病患 ID：
   - `patient-001` - 王小明（高血壓）
   - `patient-002` - 李小美（糖尿病）
   - `patient-003` - 陳大建（氣喘，已痊癒）
   - `patient-004` - 林小芬（癲癇）
   - `patient-005` - 張大偉（慢性阻塞性肺病）

5. **啟動應用程式**
   - 點擊 "Launch" 按鈕
   - 系統會自動完成 OAuth 授權
   - 應用程式將顯示選定病患的完整資料

### 方法 2: 手動設定 Launch URL

如果 Patient Viewer 不可用，可以手動構建 launch URL：

```
https://localhost:5001/launch.html?iss=https://thas.mohw.gov.tw/v/r4/sim/WzIsIiIsIiIsIkFVVE8iLDAsMCwwLCIiLCIiLCIiLCIiLCIiLCIiLCIiLDAsMSwiIl0/fhir&launch=LAUNCH_TOKEN
```

（需要從 EHR 系統取得有效的 launch token）

## 📋 測試病患資料詳情

### Patient-001: 王小明
- **性別**: 男性
- **出生日期**: 1985-03-15
- **診斷**: 高血壓（進行中）
- **用藥**: Amlodipine 5mg（每日一次）
- **最近檢查**: 血壓 120/80 mmHg

### Patient-002: 李小美
- **性別**: 女性
- **出生日期**: 1990-07-22
- **診斷**: 糖尿病（進行中）
- **用藥**: Metformin 500mg（每日兩次）
- **最近檢查**: 血糖 95 mg/dL

### Patient-003: 陳大建
- **性別**: 男性
- **出生日期**: 1978-11-08
- **診斷**: 氣喘（已痊癒）
- **用藥**: Albuterol 吸入劑（已完成）
- **最近檢查**: 體重 75.5 kg

### Patient-004: 林小芬
- **性別**: 女性
- **出生日期**: 1995-05-30
- **診斷**: 癲癇（進行中）
- **用藥**: Valproic Acid 500mg（每日兩次）
- **最近檢查**: 心率 72 次/分鐘

### Patient-005: 張大偉
- **性別**: 男性
- **出生日期**: 1982-09-18
- **診斷**: 慢性阻塞性肺病（進行中）
- **用藥**: Tiotropium 18mcg 吸入劑（每日一次）
- **最近檢查**: 體溫 36.8°C

## 🔍 驗證資料匯入

### 查詢特定病患

```bash
# 查詢王小明的資料
curl "https://thas.mohw.gov.tw/v/r4/sim/WzIsIiIsIiIsIkFVVE8iLDAsMCwwLCIiLCIiLCIiLCIiLCIiLCIiLCIiLDAsMSwiIl0/fhir/Patient/patient-001"

# 查詢王小明的觀察資料
curl "https://thas.mohw.gov.tw/v/r4/sim/WzIsIiIsIiIsIkFVVE8iLDAsMCwwLCIiLCIiLCIiLCIiLCIiLCIiLCIiLDAsMSwiIl0/fhir/Observation?patient=patient-001"

# 查詢王小明的診斷
curl "https://thas.mohw.gov.tw/v/r4/sim/WzIsIiIsIiIsIkFVVE8iLDAsMCwwLCIiLCIiLCIiLCIiLCIiLCIiLCIiLDAsMSwiIl0/fhir/Condition?patient=patient-001"

# 查詢王小明的用藥
curl "https://thas.mohw.gov.tw/v/r4/sim/WzIsIiIsIiIsIkFVVE8iLDAsMCwwLCIiLCIiLCIiLCIiLCIiLCIiLCIiLDAsMSwiIl0/fhir/MedicationRequest?patient=patient-001"
```

### 使用 Postman 測試

1. 建立新的 GET 請求
2. URL: `https://thas.mohw.gov.tw/v/r4/sim/.../fhir/Patient/patient-001`
3. Headers:
   - `Accept`: `application/fhir+json`
4. Send

## 📱 應用程式預期行為

當您透過 Patient Viewer 啟動應用程式後，應該會看到：

### 1. 授權流程
- 自動導向到 `launch.html`
- 系統查詢 SMART Configuration
- 導向 Authorization Endpoint
- 使用者同意授權（或自動授權）
- 回傳 authorization code
- 交換 access token

### 2. 資料顯示
應用程式會顯示：
- **病患基本資料**: 姓名、性別、出生日期、地址、電話
- **診斷記錄**: 診斷名稱、狀態（進行中/已痊癒）、發病日期
- **用藥記錄**: 藥物名稱、狀態、用法用量、開立日期
- **生命徵象**: 血壓、血糖、體重、心率、體溫等

## 🔧 疑難排解

### 問題 1: 找不到測試病患

**解決方法**:
- 在 Patient Viewer 的搜尋欄位輸入病患 ID（例如：`patient-001`）
- 或直接在病患列表中尋找「王小明」、「李小美」等姓名

### 問題 2: 授權失敗

**可能原因**:
- Launch URL 設定錯誤
- 應用程式未運行（確認 `https://localhost:5001` 可訪問）
- Client ID 不匹配

**解決方法**:
1. 確認應用程式正在運行：
   ```bash
   cd SmartOnFhirApp
   dotnet run
   ```
2. 確認 Launch URL 正確：`https://localhost:5001/launch.html`
3. 檢查瀏覽器控制台的錯誤訊息

### 問題 3: 顯示「未找到病患資料」

**可能原因**:
- FHIR Server 連線問題
- Access Token 過期或無效
- Patient ID 不正確

**解決方法**:
1. 確認 FHIR Server URL 正確
2. 重新進行授權流程
3. 檢查瀏覽器的 localStorage 中的 `smart_patient` 值

### 問題 4: HTTPS 憑證警告

**解決方法**:
- 開發環境的 HTTPS 憑證警告是正常的
- 在瀏覽器中選擇「繼續訪問」或「接受風險」
- 或使用 HTTP: `http://localhost:5000/launch.html`

## 📝 測試檢查清單

使用此清單確保所有功能正常：

- [ ] 應用程式成功啟動（`https://localhost:5001`）
- [ ] 從 Patient Viewer 成功啟動應用程式
- [ ] OAuth 授權流程完成
- [ ] 病患基本資料正確顯示
- [ ] 診斷記錄正確顯示（含狀態）
- [ ] 用藥記錄正確顯示（含用法用量）
- [ ] 生命徵象資料正確顯示
- [ ] 介面響應式設計正常（手機/桌面）
- [ ] 資料格式正確（日期、數值、單位）
- [ ] 中文顯示正常

## 🎯 下一步

### 功能增強建議

1. **錯誤處理**
   - 加入更完善的錯誤提示
   - 實作重試機制

2. **Token 管理**
   - 實作 Token 刷新
   - 加入 Token 過期檢查

3. **資料視覺化**
   - 加入圖表顯示生命徵象趨勢
   - 用藥時間軸視圖

4. **更多 FHIR 資源**
   - Procedure（醫療處置）
   - AllergyIntolerance（過敏資訊）
   - Immunization（疫苗接種）
   - DocumentReference（醫療文件）

### 準備上架

參考 `1014_SMART測試環境與上架流程_時賦.md` 了解：
- App 提案流程
- 上架審核要求
- 安全性規範
- 測試要求

## 📞 支援

如遇到問題：
1. 檢查瀏覽器控制台（F12）的錯誤訊息
2. 查看應用程式的命令列輸出
3. 參考 `SmartOnFhirApp/README.md` 詳細文件
4. 參考衛福部提供的技術手冊

---

**測試環境準備完成！** 🎉

您現在可以使用衛福部的測試環境來測試您的 SMART on FHIR 應用程式了。
