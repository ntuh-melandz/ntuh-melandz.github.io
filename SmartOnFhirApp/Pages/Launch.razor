@page "/launch"
@inject NavigationManager nav
@inject SmartAuthService AuthService
@inject IConfiguration Config

<PageTitle>SMART Launch</PageTitle>

<div style="display: flex; justify-content: center; align-items: center; min-height: 80vh; padding: 2rem;">
    <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 500px; width: 100%;">
        @if (!string.IsNullOrEmpty(error))
        {
            <div style="background: #ffebee; color: #c62828; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 0.5rem 0;">âŒ å•Ÿå‹•å¤±æ•—</h4>
                <p style="margin: 0;">@error</p>
                <p style="font-size: 0.9em; color: #666; margin-top: 0.5rem;">
                    Client ID: @clientId <br/>
                    Redirect URI: @(nav.BaseUri + "redirect")
                </p>
            </div>
        }
        else
        {
            <div style="text-align: center;">
                <div style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                <h2 style="margin-bottom: 1rem;">ğŸ” æ­£åœ¨è™•ç†æˆæ¬Š...</h2>
                <p style="color: #666;">æ­£åœ¨é€£æ¥è‡³ FHIR æˆæ¬Šæœå‹™</p>
            </div>
        }
    </div>
</div>

<style>
    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

@code {
    private string? iss;
    private string? launch;
    private string? error;
    private string? generatedAuthUrl;
    private string clientId = "";

    // EHR Launch é è¨­ FHIR Server
    private const string DEFAULT_EHR_FHIR_SERVER = "https://thas.mohw.gov.tw/v/r4/fhir";
    
    // Provider Standalone Launch FHIR Server (ä½¿ç”¨æ¨¡æ“¬å™¨)
    private const string STANDALONE_FHIR_SERVER = "https://thas.mohw.gov.tw/v/r4/sim/WzIsIiIsIiIsIkFVVE8iLDAsMCwwLCIiLCIiLCIiLCIiLCIiLCIiLCIiLDAsMSwiIl0/fhir";
    
    // EHR Launch éœ€è¦ launch scope
    private const string EHR_LAUNCH_SCOPES = "launch openid fhirUser patient/*.read";
    // Standalone Launch ä½¿ç”¨ launch/patient
    private const string STANDALONE_SCOPES = "openid fhirUser patient/*.read launch/patient";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            clientId = Config["Fhir:ClientId"] ?? "ntuh_fhir_app";

            var uri = nav.ToAbsoluteUri(nav.Uri);
            var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
            
            iss = query.ContainsKey("iss") ? query["iss"].ToString() : null;
            launch = query.ContainsKey("launch") ? query["launch"].ToString() : null;

            // åˆ¤æ–·å•Ÿå‹•æ¨¡å¼
            bool isEhrLaunch = !string.IsNullOrEmpty(launch);
            
            // å¦‚æœæ²’æœ‰ iss åƒæ•¸ï¼Œæ ¹æ“šæ¨¡å¼é¸æ“‡é è¨­ Server
            if (string.IsNullOrEmpty(iss))
            {
                iss = isEhrLaunch ? DEFAULT_EHR_FHIR_SERVER : STANDALONE_FHIR_SERVER;
            }

            var config = await AuthService.GetSmartConfigurationAsync(iss);
            if (config == null)
            {
                error = "ç„¡æ³•å–å¾— SMART Configuration";
                return;
            }

            var redirectUri = nav.BaseUri + "redirect";
            var state = Guid.NewGuid().ToString("N");
            var scopes = isEhrLaunch ? EHR_LAUNCH_SCOPES : STANDALONE_SCOPES;

            generatedAuthUrl = AuthService.BuildAuthorizationUrl(
                config.AuthorizationEndpoint,
                clientId,
                redirectUri,
                scopes,
                state,
                iss,
                isEhrLaunch ? launch : null  // åªæœ‰ EHR Launch æ‰å‚³ launch åƒæ•¸
            );

            await AuthService.StoreTokenResponseAsync(new Models.TokenResponse { AccessToken = "" }, iss);
            
            // ç›´æ¥å¼·åˆ¶è·³è½‰åˆ°æˆæ¬Š URL
            nav.NavigateTo(generatedAuthUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }
}
