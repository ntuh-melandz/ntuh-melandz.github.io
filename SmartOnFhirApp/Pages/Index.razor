@page "/"
@using Ganss.Xss
@inject SmartAuthService AuthService
@inject FhirClientService FhirService
@inject AiSummaryService AiService
@inject NavigationManager nav
@inject HttpClient Http
@using Markdig
@inject IJSRuntime JS

<PageTitle>ç—…æ‚£è³‡æ–™</PageTitle>

@if (!string.IsNullOrEmpty(organization?.Name))
{
    <div class="alert alert-info text-center d-flex justify-content-center align-items-center gap-2" style="margin-bottom: 1rem; border-left: none; border-radius: 8px;">
        <button class="btn btn-sm btn-outline-secondary" style="background: white;" @onclick="ResetPatientSelection">
            ğŸ­ å›ç—…æ‚£æ¸…å–®
        </button>
        <span style="font-size: 1.2rem; font-weight: bold;">ğŸ¥ @organization.Name</span>
        <button class="btn btn-sm btn-outline-danger" style="background: white;" @onclick="UnlinkHospital" disabled="@isLinking">
            âŒ è§£é™¤é€£çµ
        </button>
    </div>
}
else if (patient != null && !showPatientSelection)
{
     <div class="alert alert-warning text-center" style="margin-bottom: 1rem; border-left: none; border-radius: 8px;">
        <div class="d-flex justify-content-center align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary" style="background: white;" @onclick="ResetPatientSelection">
                ğŸ­ å›ç—…æ‚£æ¸…å–®
            </button>
            <span>âš ï¸ æ­¤ç—…æ‚£å°šæœªé€£çµè‡³ä»»ä½•é†«é™¢</span>
            @if (!showOrgSelector)
            {
                <button class="btn btn-sm btn-outline-primary" @onclick="StartLinkProcess">
                    ğŸ”— é€£çµé†«é™¢
                </button>
            }
        </div>
        
        @if (showOrgSelector)
        {
            <div class="mt-3 p-4 bg-white rounded shadow-sm" style="max-width: 600px; margin: 1rem auto; border: 1px solid #e2e8f0;">
                <h5 style="margin-bottom: 1rem; font-size: 1.1rem;">ğŸ¥ è«‹é¸æ“‡è¦é€£çµçš„é†«é™¢</h5>
                <div class="d-flex flex-column gap-3">
                    <select class="form-control" @bind="selectedOrgId" style="font-size: 1.1rem; padding: 0.8rem;">
                        <option value="">-- è«‹é¸æ“‡é†«é™¢ --</option>
                        @if (availableOrgs != null)
                        {
                            @foreach (var org in availableOrgs)
                            {
                                <option value="@org.Id">@org.Name</option>
                            }
                        }
                    </select>
                    <div class="d-flex gap-2 justify-content-end">
                         <button class="btn btn-secondary" @onclick="CancelLinkProcess" style="font-size: 1rem;">å–æ¶ˆ</button>
                         <button class="btn btn-primary" @onclick="ConfirmLinkHospital" disabled="@string.IsNullOrEmpty(selectedOrgId)" style="font-size: 1rem; padding-left: 2rem; padding-right: 2rem;">
                            ç¢ºå®šé€£çµ
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
}

@if (isLoading)
{
    <div class="card">
        <div style="text-align: center; padding: 3rem;">
            <div class="spinner" style="margin: 0 auto;"></div>
            <p style="margin-top: 1rem; color: var(--text-secondary);">@loadingStatus</p>
            @if (showRetryButton)
            {
                <button class="btn btn-outline-primary mt-3" @onclick="ReloadPage">é‡è©¦</button>
            }
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="card">
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ”</div>
            <h3>æ­¡è¿ä½¿ç”¨è‡ºå¤§é†«é™¢AIå½±åƒåˆ¤è®€çµæœæ•´åˆå¹³å°</h3>
            <p style="margin-bottom: 1.5rem;">è«‹å…ˆé€£æ¥è‡³ FHIR ä¼ºæœå™¨ä»¥å–å¾—ç—…æ‚£è³‡æ–™</p>
            
            <button class="btn btn-primary btn-lg" @onclick="StartAuthorization" style="padding: 1rem 2.5rem; font-size: 1.1rem;">
                ğŸš€ é–‹å§‹æˆæ¬Šé€£æ¥
            </button>
            
            <p style="margin-top: 1.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                å°‡é€£æ¥è‡³è¡›ç¦éƒ¨ SMART on FHIR æ¸¬è©¦ç’°å¢ƒ
            </p>
        </div>
    </div>
}
else if (showPatientSelection && availablePatients != null)
{
    <div class="card">
        <div class="card-header">
            <h2>ğŸ‘¥ è«‹é¸æ“‡ç—…æ‚£</h2>
        </div>
        <div class="card-body">
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <div style="display: flex; gap: 8px; flex: 1;">
                            <select @bind="selectedSearchOrgId" class="form-select search-input" style="max-width: 380px; padding-right: 1rem; background-position: right 0.75rem center;">
                                <option value="">-- æ‰€æœ‰é†«é™¢ --</option>
                                @if (availableOrgs != null)
                                {
                                    @foreach (var org in availableOrgs)
                                    {
                                        <option value="@org.Id">@org.Name</option>
                                    }
                                }
                            </select>
                            <input @bind="searchQuery" @bind:event="oninput" @onkeyup="HandleSearch" 
                                   placeholder="è¼¸å…¥å§“åæˆ– ID æœå°‹..." 
                                   class="form-control search-input" style="flex: 1;" />
                        </div>
                        @if (!string.IsNullOrEmpty(searchQuery))
                        {
                            <button class="btn-clear" @onclick="ClearSearch" title="æ¸…é™¤">âœ•</button>
                        }
                    </div>
                    <button class="btn btn-primary btn-search" @onclick="SearchPatients">æœå°‹</button>
                </div>

            @if (isLoadingPatients)
            {
                <div class="text-center py-3">
                    <div class="spinner"></div>
                    <p>æœå°‹ä¸­...</p>
                </div>
            }
            else if (availablePatients?.Any() == true)
            {
            <div class="patient-list">
                @foreach (var p in availablePatients)
                {
                    <div class="patient-item" @onclick="() => SelectPatient(p.Id)">
                        <div class="patient-avatar">
                            @if (p.Gender == "female")
                            {
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ed64a6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                            }
                            else if (p.Gender == "male")
                            {
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4299e1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                            }
                            else
                            {
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#a0aec0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                            }
                        </div>
                        <div class="patient-info">
                            <div class="patient-main text-dark">
                                <span class="patient-name">@GetPatientDisplayName(p)</span>
                            </div>
                            <div class="patient-sub">
                                <span class="patient-id">ID: <span class="id-text">@p.Id</span></span>
                            </div>
                            <div class="patient-details">
                                <span class="detail-text">@(p.Gender == "male" ? "ç”·" : p.Gender == "female" ? "å¥³" : "æœªçŸ¥")</span>
                                <span class="separator">|</span>
                                <span class="detail-text">@GetAge(p.BirthDate)</span>
                                <span class="separator">|</span>
                                <span class="detail-text">(@(p.BirthDate ?? "æœªçŸ¥"))</span>
                                 @if (!string.IsNullOrEmpty(p.ManagingOrganization?.Display))
                                {
                                    <span class="badge badge-info ms-2">ğŸ¥ @p.ManagingOrganization.Display</span>
                                }
                            </div>
                        </div>
                        <div class="patient-action">
                            <span class="chevron">â€º</span>
                        </div>
                    </div>
                }
            </div>
            }
            else
            {
                <div class="text-center py-3 text-muted">
                    æ‰¾ä¸åˆ°ç¬¦åˆçš„ç—…æ‚£è³‡æ–™
                </div>
            }

            @if (totalPatientCount > 0)
            {
                <div class="pagination-container mt-3">
                    <div class="pagination-info">
                        é¡¯ç¤ºç¬¬ @((currentPage - 1) * PAGE_SIZE + 1) - @Math.Min(currentPage * PAGE_SIZE, totalPatientCount) ç­†ï¼Œå…± @totalPatientCount ç­†
                    </div>
                    <div class="pagination-controls">
                        <button class="btn btn-sm btn-outline-secondary" 
                                @onclick="GoToPreviousPage" 
                                disabled="@(currentPage <= 1 || isLoadingPatients)">
                            â—€ ä¸Šä¸€é 
                        </button>
                        
                        @{
                            var pagesToShow = GetPagesToShow();
                        }
                        @foreach (var pageItem in pagesToShow)
                        {
                            if (pageItem == -1)
                            {
                                <span class="pagination-ellipsis">...</span>
                            }
                            else
                            {
                                var pageNum = pageItem;
                                <button class="btn btn-sm @(pageNum == currentPage ? "btn-primary" : "btn-outline-primary")"
                                        @onclick="() => GoToPage(pageNum)"
                                        disabled="@isLoadingPatients">
                                    @pageNum
                                </button>
                            }
                        }
                        
                        <button class="btn btn-sm btn-outline-secondary" 
                                @onclick="GoToNextPage" 
                                disabled="@(currentPage >= totalPages || isLoadingPatients)">
                            ä¸‹ä¸€é  â–¶
                        </button>
                    </div>
                </div>
            }
            @if (isLoadingPatients)
            {
                <div class="text-center mt-3">
                    <div class="spinner"></div>
                    <p class="text-muted">è¼‰å…¥ä¸­...</p>
                </div>
            }
        </div>
    </div>
    
    <style>
        /* Search Bar Styling */
        .search-container {
            display: flex;
            gap: 12px;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .search-input-wrapper {
            position: relative;
            flex: 1;
        }

        .search-input {
            width: 100%;
            padding: 0.8rem 2.5rem 0.8rem 1rem; /* Right padding for clear button */
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #a0aec0;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s, background 0.2s;
        }

        .btn-clear:hover {
            color: var(--text-primary);
            background-color: #f7fafc;
        }

        .btn-search {
            padding: 0.8rem 1.5rem;
            font-weight: 600;
        }

        /* Patient List Styling */
        .patient-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .patient-item {
            display: flex;
            align-items: center;
            padding: 1.2rem;
            background: white;
            border: 1px solid #edf2f7;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .patient-item:hover {
            background: #f8faff; /* Light blueish tint */
            border-color: #c3dafe;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .patient-avatar {
            font-size: 2.5rem;
            margin-right: 1.25rem;
            background: #f7fafc;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .patient-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .patient-main {
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .patient-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .patient-sub {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 2px;
        }

        .patient-id {
            font-family: monospace;
            color: #718096;
        }

        .id-text {
            color: #4a5568; /* Darker gray for definition */
            font-weight: 600;
        }

        .patient-details {
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            color: #4a5568;
        }

        .detail-text {
            font-weight: 500;
        }

        .separator {
            margin: 0 8px;
            color: #cbd5e0;
        }

        .patient-action {
            padding-left: 1rem;
            color: #cbd5e0;
            transition: color 0.2s;
        }

        .patient-item:hover .patient-action {
            color: var(--primary-color);
        }

        .chevron {
            font-size: 2rem;
            line-height: 1;
            font-weight: 300;
        }

        /* Pagination Styling */
        .pagination-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0;
            border-top: 1px solid #edf2f7;
        }

        .pagination-info {
            font-size: 0.9rem;
            color: #718096;
        }

        .pagination-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .pagination-controls .btn {
            min-width: 40px;
        }

        .pagination-ellipsis {
            padding: 0.25rem 0.5rem;
            color: #718096;
            font-weight: bold;
        }
    </style>
}
else if (patient != null)
{
    <!-- ç—…æ‚£åŸºæœ¬è³‡æ–™ -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="d-flex align-items-center gap-2">
                @if (patient.Gender == "female")
                {
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ed64a6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                }
                else if (patient.Gender == "male")
                {
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#4299e1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                }
                else
                {
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#a0aec0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                }
                ç—…æ‚£åŸºæœ¬è³‡æ–™
            </h2>

        </div>
        <div class="card-body">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">å§“å</span>
                    <span class="info-value">@GetPatientName()</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ€§åˆ¥</span>
                    <span class="info-value">@GetGenderDisplay()</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å¹´é½¡</span>
                    <span class="info-value">@GetAge(patient.BirthDate)</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å‡ºç”Ÿæ—¥æœŸ</span>
                    <span class="info-value">@(patient.BirthDate ?? "æœªæä¾›")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ç—…æ­·è™Ÿ</span>
                    <span class="info-value">@(patient.Id ?? "N/A")</span>
                </div>
            </div>
        </div>
    </div>

    <!-- çœ¼åº•é¡æª¢æŸ¥çµæœ -->
    @if (fundusReports?.Any() == true)
    {
        <div class="card">
            <div class="card-header">
                <h2>ğŸ‘ï¸ AIçœ¼åº•é¡æª¢æŸ¥çµæœ</h2>
            </div>
            <div class="card-body">
                @foreach (var report in fundusReports)
                {
                    <div class="fundus-result-card @GetReferralClass(report.Conclusion)">
                        <div class="fundus-content">
                            <div class="fundus-image-container">
                                @if (fundusMediaCache.TryGetValue(report.Id, out var media) && media?.Content?.Data != null)
                                {
                                    <img src="data:@(media.Content.ContentType ?? "image/png");base64,@media.Content.Data" 
                                         alt="çœ¼åº•å½±åƒ" class="fundus-image" 
                                         style="width: 180px; height: 180px; object-fit: cover; cursor: pointer;"
                                         @onclick='() => ShowImage($"data:{(media.Content.ContentType ?? "image/png")};base64,{media.Content.Data}")' />
                                }
                                else
                                {
                                    <div class="fundus-image-placeholder">
                                        <span>ğŸ”</span>
                                        <small>å½±åƒè¼‰å…¥ä¸­...</small>
                                    </div>
                                }
                                @if (report.Media?.FirstOrDefault()?.Comment != null)
                                {
                                    <div class="fundus-eye-label">@report.Media.First().Comment</div>
                                }
                            </div>
                            <div class="fundus-info">
                                <div class="fundus-header">
                                    <span class="referral-badge @GetReferralBadgeClass(report.Conclusion)">
                                        @GetReferralIcon(report.Conclusion) @(report.Conclusion ?? "å¾…åˆ¤è®€")
                                    </span>
                                    <span class="fundus-date">@FormatDateTime(report.EffectiveDateTime)</span>
                                </div>
                                <div class="fundus-details">
                                    @if (report.ConclusionCode?.FirstOrDefault()?.Text != null)
                                    {
                                        <p class="conclusion-text">@report.ConclusionCode.First().Text</p>
                                    }
                                    @if (report.Performer?.Any() == true)
                                    {
                                        <p class="performer-info">
                                            <strong>åŸ·è¡Œæ©Ÿæ§‹ï¼š</strong>@report.Performer.FirstOrDefault()?.Display
                                        </p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- è¨ºæ–· -->
    @if (conditions?.Any() == true)
    {
        <div class="card">
            <div class="card-header">
                <h2>ğŸ©º è¨ºæ–·è¨˜éŒ„</h2>
            </div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>è¨ºæ–·</th>
                            <th>ç‹€æ…‹</th>
                            <th>ç™¼ç—…æ—¥æœŸ</th>
                            <th>ç—Šç™’æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var condition in conditions)
                        {
                            <tr>
                                <td>@FhirService.GetCodeDisplay(condition.Code)</td>
                                <td>
                                    @if (condition.ClinicalStatus?.Coding?.Any() == true)
                                    {
                                        var status = condition.ClinicalStatus.Coding.First().Code;
                                        var badgeClass = status == "active" ? "badge-warning" :
                                                        status == "resolved" ? "badge-success" : "badge-info";
                                        <span class="badge @badgeClass">
                                            @(status == "active" ? "é€²è¡Œä¸­" : status == "resolved" ? "å·²ç—Šç™’" : status)
                                        </span>
                                    }
                                </td>
                                <td>@(condition.OnsetDateTime ?? "-")</td>
                                <td>@(condition.AbatementDateTime ?? "-")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <!-- Image Preview Modal -->
    @if (!string.IsNullOrEmpty(previewImageSrc))
    {
        <div class="image-preview-overlay" @onclick="CloseImage">
            <div class="image-preview-content">
                <img src="@previewImageSrc" alt="æ”¾å¤§é è¦½" class="preview-full-image" />
                <button class="btn-close-preview" @onclick="CloseImage">âœ•</button>
            </div>
        </div>
    }

    <style>
        .image-preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }

        .image-preview-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
        }

        .preview-full-image {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 2px solid white;
        }

        .btn-close-preview {
            position: absolute;
            top: -40px;
            right: 0;
            background: transparent;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .btn-close-preview:hover {
            opacity: 1;
        }
    </style>

    <!-- ç”¨è—¥ -->
    @if (medications?.Any() == true)
    {
        <div class="card">
            <div class="card-header">
                <h2>ğŸ’Š ç”¨è—¥è¨˜éŒ„</h2>
            </div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>è—¥ç‰©åç¨±</th>
                            <th>ç‹€æ…‹</th>
                            <th>ç”¨æ³•ç”¨é‡</th>
                            <th>é–‹ç«‹æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var med in medications)
                        {
                            <tr>
                                <td>@FhirService.GetCodeDisplay(med.MedicationCodeableConcept)</td>
                                <td>
                                    @{
                                        var badgeClass = med.Status == "active" ? "badge-success" :
                                                        med.Status == "completed" ? "badge-info" : "badge-warning";
                                    }
                                    <span class="badge @badgeClass">
                                        @(med.Status == "active" ? "ä½¿ç”¨ä¸­" : med.Status == "completed" ? "å·²å®Œæˆ" : med.Status)
                                    </span>
                                </td>
                                <td>
                                    @FhirService.GetDosageDisplay(med)
                                </td>
                                <td>@(med.AuthoredOn ?? "-")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <!-- ç”Ÿå‘½å¾µè±¡ -->
    @if (observations?.Any() == true)
    {
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2>ğŸ“Š ç”Ÿå‘½å¾µè±¡èˆ‡æª¢é©—</h2>
            </div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>é …ç›®</th>
                            <th>æ•¸å€¼</th>
                            <th>æª¢æ¸¬æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var obs in observations)
                        {
                            <tr>
                                <td>@FhirService.GetCodeDisplay(obs.Code)</td>
                                <td>
                                    @if (obs.ValueQuantity != null)
                                    {
                                        <span>@obs.ValueQuantity.Value @obs.ValueQuantity.Unit</span>
                                    }
                                    else if (obs.Component?.Any() == true)
                                    {
                                        @foreach (var component in obs.Component)
                                        {
                                            <div>
                                                @FhirService.GetCodeDisplay(component.Code):
                                                @component.ValueQuantity?.Value @component.ValueQuantity?.Unit
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <span>-</span>
                                    }
                                </td>
                                <td>@(obs.EffectiveDateTime ?? "-")</td>
                            </tr>
                        }
                    </tbody>
                </table>
                
            </div>
        </div>
    }

    <!-- æ™ºæ…§æ‘˜è¦ -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">ğŸ¤– æ™ºæ…§æ‘˜è¦</h2>
            <button class="btn btn-primary" @onclick="GenerateSummary" disabled="@isGeneratingSummary">
                @if (isGeneratingSummary)
                {
                    <span>â³ ç”Ÿæˆä¸­...</span>
                }
                else
                {
                    <span>âœ¨ ç”¢ç”Ÿæ‘˜è¦</span>
                }
            </button>
        </div>
        @if (!string.IsNullOrEmpty(aiSummaryResult))
        {
            <div class="card-body">
                <div class="ai-report-container">
                    @((MarkupString)ConvertMarkdownToHtml(aiSummaryResult))
                </div>
            </div>
        }
    </div>


    @if ((conditions?.Any() != true) && (medications?.Any() != true) && (observations?.Any() != true))
    {
        <div class="card">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‹</div>
                <h3>æš«ç„¡é¡å¤–é†«ç™‚è¨˜éŒ„</h3>
                <p>æ­¤ç—…æ‚£ç›®å‰æ²’æœ‰è¨ºæ–·ã€ç”¨è—¥æˆ–æª¢é©—è¨˜éŒ„</p>
            </div>
        </div>
    }
}

@code {
    private bool isLoading = true;
    private string loadingStatus = "æ­£åœ¨åˆå§‹åŒ–...";
    private bool showRetryButton = false;
    private bool isLinking = false;
    private string? errorMessage;

    private Patient? patient;
    private Organization? organization;
    private List<Observation>? observations;
    private List<Condition>? conditions;
    private List<MedicationRequest>? medications;
    private List<DiagnosticReport>? fundusReports;
    private Dictionary<string, Media> fundusMediaCache = new();

    private string? fhirBaseUrl;
    private string? patientId;

    // ç—…æ‚£é¸æ“‡æ¨¡å¼
    private bool showPatientSelection = false;
    private bool isLoadingPatients = false;
    private const int PAGE_SIZE = 10;
    private int currentPage = 1;
    private int totalPatientCount = 0;
    private int totalPages => (int)Math.Ceiling((double)totalPatientCount / PAGE_SIZE);
    private List<Patient>? availablePatients;
    private bool showOrgSelector = false;
    private List<Organization>? availableOrgs;
    private string selectedOrgId = "";
    private string selectedSearchOrgId = "org-ntuh"; // Default to NTUH
    private string searchQuery = "";

    // AI Summary
    private bool isGeneratingSummary = false;
    private static readonly MarkdownPipeline _markdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();
    private string? aiSummaryResult;

    protected override async Task OnInitializedAsync()
    {
        // è¨­å®š 30 ç§’é€¾æ™‚
        var cts = new CancellationTokenSource();
        cts.CancelAfter(TimeSpan.FromSeconds(30));

        try
        {
            // ä½¿ç”¨ Task.Run åŸ·è¡Œä¸»è¦é‚è¼¯ï¼Œä»¥ä¾¿å¯ä»¥ç›£æ§é€¾æ™‚
            await Task.Run(async () => 
            {
                await InitializeAppAsync();
            }, cts.Token);
        }
        catch (OperationCanceledException)
        {
            errorMessage = "è¼‰å…¥é€¾æ™‚ (30ç§’)ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– FHIR ä¼ºæœå™¨ç‹€æ…‹ã€‚";
            isLoading = false;
            showRetryButton = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤ï¼š{ex.Message}";
            isLoading = false;
            showRetryButton = true;
        }
    }

    private async Task InitializeAppAsync()
    {
        try
        {
            loadingStatus = "æ­£åœ¨è®€å–è¨­å®š...";
            StateHasChanged();

            // å–å¾—å„²å­˜çš„è³‡æ–™
            fhirBaseUrl = await AuthService.GetStoredFhirBaseUrlAsync();
            patientId = await AuthService.GetStoredPatientIdAsync();
            var accessToken = await AuthService.GetStoredAccessTokenAsync();

            if (string.IsNullOrEmpty(fhirBaseUrl))
            {
                errorMessage = "æœªæ‰¾åˆ° FHIR Server URLã€‚è«‹é€é /launch å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ã€‚";
                isLoading = false;
                return;
            }

            loadingStatus = "æ­£åœ¨é€£æ¥ FHIR ä¼ºæœå™¨...";
            StateHasChanged();

            // Load available organizations for search filter
            availableOrgs = await FhirService.GetOrganizationsAsync(fhirBaseUrl);
            
            // å¦‚æœæ²’æœ‰ Patient IDï¼Œé¡¯ç¤ºç—…æ‚£é¸æ“‡åˆ—è¡¨
            // Check if patientId is in session storage (from launch)
            var patientIdInSession = await JS.InvokeAsync<string>("sessionStorage.getItem", "patientId");

            if (string.IsNullOrEmpty(patientId) && string.IsNullOrEmpty(patientIdInSession))
            {
                loadingStatus = "æ­£åœ¨è¼‰å…¥ç—…æ‚£æ¸…å–®...";
                StateHasChanged();
                
                showPatientSelection = true;
                await LoadPatientList();
                isLoading = false;
                return;
            }
            else if (!string.IsNullOrEmpty(patientIdInSession) && string.IsNullOrEmpty(patientId))
            {
                // If patientId is in session but not yet loaded into state, use it
                patientId = patientIdInSession;
                await AuthService.StorePatientIdAsync(patientId); // Store it for future visits
                await JS.InvokeVoidAsync("sessionStorage.removeItem", "patientId"); // Clear from session
            }

            // Access Token æª¢æŸ¥ - è¡›ç¦éƒ¨æ¸¬è©¦ç’°å¢ƒä¸éœ€è¦ token
            if (string.IsNullOrEmpty(accessToken))
            {
                Console.WriteLine("è­¦å‘Šï¼šæœªæ‰¾åˆ° Access Tokenã€‚ä½¿ç”¨å…¬é–‹ FHIR Server æ¨¡å¼ã€‚");
            }

            loadingStatus = "æ­£åœ¨è¼‰å…¥ç—…æ‚£è©³ç´°è³‡æ–™...";
            StateHasChanged();

            // è¼‰å…¥ç—…æ‚£è³‡æ–™
            await LoadPatientData();
        }
        catch (Exception ex)
        {
            errorMessage = $"ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}";
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ReloadPage()
    {
        nav.NavigateTo(nav.Uri, forceLoad: true);
    }

    private void StartAuthorization()
    {
        // å°å‘ /launch é–‹å§‹ SMART on FHIR æˆæ¬Šæµç¨‹
        nav.NavigateTo("/launch", forceLoad: true);
    }

    private async Task LoadPatientList()
    {
        currentPage = 1;
        await LoadPatientPage(1);
    }

    private async Task LoadPatientPage(int page)
    {
        isLoadingPatients = true;
        StateHasChanged();
        
        try
        {
            var offset = (page - 1) * PAGE_SIZE;
            var result = await FhirService.GetPatientsAsync(fhirBaseUrl!, count: PAGE_SIZE, name: searchQuery, offset: offset, organizationId: selectedSearchOrgId);
            
            
            availablePatients = result.Patients;
            
            // ä½¿ç”¨ FHIR Bundle è¿”å›çš„ç¸½æ•¸
            if (result.Total > 0)
            {
                totalPatientCount = result.Total;
            }
            else if (availablePatients != null && availablePatients.Any())
            {
                // Fallback: ä¼°ç®—ç¸½æ•¸
                if (availablePatients.Count >= PAGE_SIZE)
                {
                    totalPatientCount = Math.Max(totalPatientCount, page * PAGE_SIZE + PAGE_SIZE);
                }
                else
                {
                    totalPatientCount = (page - 1) * PAGE_SIZE + availablePatients.Count;
                }
            }
            else if (page == 1)
            {
                totalPatientCount = 0;
            }
            
            currentPage = page;
        }
        catch (Exception ex)
        {
            errorMessage = $"ç„¡æ³•è¼‰å…¥ç—…æ‚£åˆ—è¡¨ï¼š{ex.Message}";
        }
        finally
        {
            isLoadingPatients = false;
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task GoToPage(int page)
    {
        if (page < 1 || page > totalPages || page == currentPage) return;
        await LoadPatientPage(page);
    }

    private async Task GoToPreviousPage()
    {
        if (currentPage > 1)
        {
            await LoadPatientPage(currentPage - 1);
        }
    }

    private async Task GoToNextPage()
    {
        if (currentPage < totalPages)
        {
            await LoadPatientPage(currentPage + 1);
        }
    }

    private List<int> GetPagesToShow()
    {
        var pages = new List<int>();
        
        if (totalPages <= 9)
        {
            // é¡¯ç¤ºæ‰€æœ‰é ç¢¼
            for (int i = 1; i <= totalPages; i++)
            {
                pages.Add(i);
            }
        }
        else
        {
            // æ™ºæ…§åˆ†é ï¼š1 2 3 ... [current-1] [current] [current+1] ... last-2 last-1 last
            
            // å‰3é 
            pages.Add(1);
            pages.Add(2);
            pages.Add(3);
            
            // ä¸­é–“éƒ¨åˆ†
            int rangeStart = Math.Max(4, currentPage - 1);
            int rangeEnd = Math.Min(totalPages - 3, currentPage + 1);
            
            if (rangeStart > 4)
            {
                pages.Add(-1); // ellipsis
            }
            
            for (int i = rangeStart; i <= rangeEnd; i++)
            {
                if (!pages.Contains(i) && i > 3 && i < totalPages - 2)
                {
                    pages.Add(i);
                }
            }
            
            if (rangeEnd < totalPages - 3)
            {
                pages.Add(-1); // ellipsis
            }
            
            // å¾Œ3é 
            if (!pages.Contains(totalPages - 2)) pages.Add(totalPages - 2);
            if (!pages.Contains(totalPages - 1)) pages.Add(totalPages - 1);
            if (!pages.Contains(totalPages)) pages.Add(totalPages);
        }
        
        return pages;
    }

    private async Task HandleSearch(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchPatients();
        }
    }

    private async Task SearchPatients()
    {
        currentPage = 1;
        totalPatientCount = 0;
        await LoadPatientPage(1);
    }

    private async Task ClearSearch()
    {
        searchQuery = "";
        await LoadPatientList();
    }

    private async Task ResetPatientSelection()
    {
        patientId = null;
        patient = null;
        organization = null;
        observations = null;
        conditions = null;
        medications = null;
        fundusReports = null;
        fundusMediaCache.Clear();
        aiSummaryResult = null; // æ¸…é™¤ AI ç¸½çµ
        showPatientSelection = true;
        
        // æ¸…é™¤å„²å­˜çš„ç—…æ‚£ IDï¼Œä½†ä¿ç•™ Token
        await AuthService.RemovePatientIdAsync();
        
        if (availablePatients == null)
        {
            await LoadPatientList();
        }
    }

    private async Task SelectPatient(string selectedPatientId)
    {
        isLoading = true;
        showPatientSelection = false;
        patientId = selectedPatientId;
        aiSummaryResult = null; // æ¸…é™¤ AI ç¸½çµ

        // å„²å­˜é¸æ“‡çš„ç—…æ‚£ ID
        await AuthService.StorePatientIdAsync(patientId);

        await LoadPatientData();
        isLoading = false;
        StateHasChanged();
    }

    private async Task LoadPatientData()
    {
        patient = await FhirService.GetPatientAsync(fhirBaseUrl!, patientId!);

        if (patient == null)
        {
            errorMessage = "ç„¡æ³•è¼‰å…¥ç—…æ‚£è³‡æ–™ã€‚";
            return;
        }

        // è¼‰å…¥æ©Ÿæ§‹è³‡æ–™
        if (patient.ManagingOrganization != null && !string.IsNullOrEmpty(patient.ManagingOrganization.ReferenceValue))
        {
            var orgId = patient.ManagingOrganization.ReferenceValue.Split('/').Last();
            organization = await FhirService.GetOrganizationAsync(fhirBaseUrl!, orgId);
        }

        // ä¸¦è¡Œè¼‰å…¥å…¶ä»–è³‡æ–™
        var observationsTask = FhirService.GetObservationsAsync(fhirBaseUrl!, patientId!);
        var conditionsTask = FhirService.GetConditionsAsync(fhirBaseUrl!, patientId!);
        var medicationsTask = FhirService.GetMedicationRequestsAsync(fhirBaseUrl!, patientId!);
        var fundusReportsTask = FhirService.GetDiagnosticReportsAsync(fhirBaseUrl!, patientId!, "92134-4");

        await Task.WhenAll(observationsTask, conditionsTask, medicationsTask, fundusReportsTask);

        observations = await observationsTask ?? new List<Observation>();
        conditions = await conditionsTask ?? new List<Condition>();
        medications = await medicationsTask ?? new List<MedicationRequest>();
        fundusReports = await fundusReportsTask ?? new List<DiagnosticReport>();
        
        // è¼‰å…¥çœ¼åº•å½±åƒ
        fundusMediaCache.Clear();
        foreach (var report in fundusReports)
        {
            if (report.Media?.FirstOrDefault()?.Link?.ReferenceValue != null)
            {
                var mediaRef = report.Media.First().Link!.ReferenceValue;
                if (mediaRef != null)
                {
                    var mediaId = mediaRef.Split('/').Last();
                    var media = await FhirService.GetMediaAsync(fhirBaseUrl!, mediaId);
                    if (media != null)
                    {
                        fundusMediaCache[report.Id] = media;
                    }
                }
            }
        }

        // å˜—è©¦è¨˜éŒ„å­˜å–äº‹ä»¶åˆ° FHIR Server (AuditEvent)
        // Pre-fetch IP in main context (JS interop needs sync context)
        string? clientIp = null;
        try
        {
            clientIp = await JS.InvokeAsync<string>("getClientIp");
        }
        catch { /* Ignore IP fetch errors */ }

        _ = Task.Run(async () =>
        {
            try
            {
                var patientName = FhirService.GetDisplayName(patient?.Name?.FirstOrDefault());
                var result = await FhirService.PostAuditEventAsync(fhirBaseUrl!, patientId!, patientName, "SmartOnFhirApp", clientIp);
                Console.WriteLine($"[AuditEvent] Posted: Success={result.Success}, Status={result.StatusCode}, IP={clientIp ?? "unknown"}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[AuditEvent] Error: {ex.Message}");
            }
        });

        // è‡ªå‹•è§¸ç™¼æ™ºæ…§æ‘˜è¦
        _ = GenerateSummary();
    }

    private string GetPatientName()
    {
        if (patient?.Name?.Any() == true)
        {
            return FhirService.GetDisplayName(patient.Name.First());
        }
        return "æœªæä¾›";
    }

    private string GetPatientDisplayName(Patient p)
    {
        if (p?.Name?.Any() == true)
        {
            return FhirService.GetDisplayName(p.Name.First());
        }
        return p?.Id ?? "æœªçŸ¥";
    }

    private string GetGenderDisplay()
    {
        return patient?.Gender switch
        {
            "male" => "ç”·æ€§",
            "female" => "å¥³æ€§",
            "other" => "å…¶ä»–",
            "unknown" => "æœªçŸ¥",
            _ => "æœªæä¾›"
        };
    }

    private async Task StartLinkProcess()
    {
        isLinking = true;
        try 
        {
            availableOrgs = await FhirService.GetOrganizationsAsync(fhirBaseUrl!);
            
            // Check if Test Hospital exists
            bool hasTestHospital = availableOrgs != null && availableOrgs.Any(o => o.Name == "æ¸¬è©¦é†«é™¢");

            if (!hasTestHospital)
            {
                 // Create it if not found, regardless of whether list is empty or not
                 await LinkTestHospital(); 
                 availableOrgs = await FhirService.GetOrganizationsAsync(fhirBaseUrl!);
            }
            
            showOrgSelector = true;
        }
        catch(Exception ex)
        {
            errorMessage = $"ç„¡æ³•è¼‰å…¥é†«é™¢åˆ—è¡¨: {ex.Message}";
        }
        finally
        {
            isLinking = false;
        }
    }

    private void CancelLinkProcess()
    {
        showOrgSelector = false;
        selectedOrgId = "";
    }

    private async Task ConfirmLinkHospital()
    {
        if (string.IsNullOrEmpty(selectedOrgId) || availableOrgs == null) return;

        var org = availableOrgs.FirstOrDefault(o => o.Id == selectedOrgId);
        if (org == null) return;

        isLinking = true;
        try
        {
            var success = await FhirService.UpdatePatientOrganizationAsync(fhirBaseUrl!, patientId!, org.Id, org.Name ?? "Unknown");
            if (success)
            {
                organization = org;
                showOrgSelector = false;
                
                // Refresh data to ensure consistency
                await LoadPatientData();
            }
            else
            {
                errorMessage = "é€£çµå¤±æ•—";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"é€£çµéŒ¯èª¤: {ex.Message}";
        }
        finally
        {
            isLinking = false;
        }
    }

    private async Task UnlinkHospital()
    {
        if (!await JS.InvokeAsync<bool>("confirm", "ç¢ºå®šè¦è§£é™¤é†«é™¢é€£çµå—ï¼Ÿ")) return;

        isLinking = true;
        try
        {
            var success = await FhirService.ClearPatientOrganizationAsync(fhirBaseUrl!, patientId!);
            if (success)
            {
                organization = null;
                // Refresh data
                await LoadPatientData();
            }
            else
            {
                errorMessage = "è§£é™¤é€£çµå¤±æ•—";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"è§£é™¤éŒ¯èª¤: {ex.Message}";
        }
        finally
        {
            isLinking = false;
        }
    }

    // Keep this for fallback creation
    private async Task LinkTestHospital()
    {
        try
        {
            var org = new Organization
            {
                Name = "æ¸¬è©¦é†«é™¢",
                Type = new List<CodeableConcept>
                {
                    new CodeableConcept
                    {
                        Coding = new List<Coding>
                        {
                            new Coding { System = "http://terminology.hl7.org/CodeSystem/organization-type", Code = "prov", Display = "Healthcare Provider" }
                        }
                    }
                }
            };
            await FhirService.CreateOrganizationAsync(fhirBaseUrl!, org);
        }
        catch {}
    }

    private async Task GenerateSummary()
    {
        if (patient == null || isGeneratingSummary) return;

        isGeneratingSummary = true;
        aiSummaryResult = null;
        StateHasChanged();

        try
        {
            aiSummaryResult = await AiService.SummarizePatientDataAsync(
                patient, 
                conditions ?? new List<Condition>(), 
                medications ?? new List<MedicationRequest>(), 
                observations ?? new List<Observation>(),
                fundusReports ?? new List<DiagnosticReport>()
            );
        }
        catch (Exception ex)
        {
            aiSummaryResult = $"ç”Ÿæˆå¤±æ•—: {ex.Message}";
        }
        finally
        {
            isGeneratingSummary = false;
            StateHasChanged();
        }
    }

    private string GetAge(string? birthDateString)
    {
        if (string.IsNullOrEmpty(birthDateString) || !DateTime.TryParse(birthDateString, out var birthDate))
        {
            return "?";
        }
        
        var today = DateTime.Today;
        var years = today.Year - birthDate.Year;
        var months = today.Month - birthDate.Month;
        
        if (today.Day < birthDate.Day)
        {
            months--;
        }
        
        if (months < 0)
        {
            years--;
            months += 12;
        }
        
        if (years < 0) return "?";
        
        if (months == 0)
        {
            return $"{years}æ­²";
        }
        return $"{years}æ­²{months}å€‹æœˆ";
    }

    private string ConvertMarkdownToHtml(string markdown)
    {
        if (string.IsNullOrEmpty(markdown)) return "";

        // å¦‚æœåŒ…å« assistantfinalï¼Œåªæ“·å–ä¹‹å¾Œçš„å…§å®¹
        string finalContent = markdown;
        const string marker = "assistantfinal";
        int markerIndex = markdown.IndexOf(marker);
        if (markerIndex >= 0)
        {
            finalContent = markdown.Substring(markerIndex + marker.Length).Trim();
        }

        var html = Markdown.ToHtml(finalContent, _markdownPipeline);
        var sanitizer = new HtmlSanitizer();
        return sanitizer.Sanitize(html);
    }

    // Fundus/Referral helper methods
    private string GetReferralClass(string? conclusion)
    {
        return conclusion switch
        {
            "å»ºè­°è½‰è¨º" => "referral-needed",
            "ç·Šæ€¥è½‰è¨º" => "referral-urgent",
            "è¿½è¹¤è§€å¯Ÿ" => "referral-followup",
            "ç„¡éœ€è½‰è¨º" => "referral-normal",
            _ => ""
        };
    }

    private string GetReferralBadgeClass(string? conclusion)
    {
        return conclusion switch
        {
            "å»ºè­°è½‰è¨º" => "badge-refer",
            "ç·Šæ€¥è½‰è¨º" => "badge-urgent",
            "è¿½è¹¤è§€å¯Ÿ" => "badge-followup",
            "ç„¡éœ€è½‰è¨º" => "badge-normal",
            _ => "badge-info"
        };
    }

    private string GetReferralIcon(string? conclusion)
    {
        return conclusion switch
        {
            "å»ºè­°è½‰è¨º" => "âš ï¸",
            "ç·Šæ€¥è½‰è¨º" => "ğŸš¨",
            "è¿½è¹¤è§€å¯Ÿ" => "ğŸ‘ï¸",
            "ç„¡éœ€è½‰è¨º" => "âœ…",
            _ => "ğŸ“‹"
        };
    }

    private string? previewImageSrc;

    private string FormatDateTime(string? dateTimeStr)
    {
        if (DateTime.TryParse(dateTimeStr, out var date))
        {
            return date.ToString("yyyy/MM/dd HH:mm");
        }
        return dateTimeStr ?? "-";
    }

    private void ShowImage(string src)
    {
        previewImageSrc = src;
    }

    private void CloseImage()
    {
        previewImageSrc = null;
    }
}
