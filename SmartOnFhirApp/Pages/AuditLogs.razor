@page "/audit-logs"
@inject FhirClientService FhirService
@inject SmartAuthService AuthService
@inject NavigationManager nav

<PageTitle>å­˜å–è¨˜éŒ„ - SMART on FHIR</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ğŸ“‹ å­˜å–è¨˜éŒ„</h1>
        <button class="btn btn-outline-secondary" @onclick="GoBack">
            â† å›é¦–é 
        </button>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>AuditEvent Records</span>
            <button class="btn btn-primary btn-sm" @onclick="LoadAuditEvents" disabled="@isLoading">
                @if (isLoading)
                {
                    <span>â³ è¼‰å…¥ä¸­...</span>
                }
                else
                {
                    <span>ğŸ”„ é‡æ–°æ•´ç†</span>
                }
            </button>
        </div>
        <div class="card-body">
            @if (errorMessage != null)
            {
                <div class="alert alert-warning">@errorMessage</div>
            }
            
            @if (auditEvents == null && !isLoading)
            {
                <p class="text-muted">é»æ“Šã€Œé‡æ–°æ•´ç†ã€æŒ‰éˆ•è¼‰å…¥å­˜å–è¨˜éŒ„</p>
            }
            else if (auditEvents != null)
            {
                @if (auditEvents.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>æ™‚é–“</th>
                                    <th>å‹•ä½œ</th>
                                    <th>ä¾†æº App</th>
                                    <th>ä¾†æº IP</th>
                                    <th>ç—…æ‚£</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var evt in auditEvents)
                                {
                                    <tr>
                                        <td>@FormatDateTime(evt.Recorded)</td>
                                        <td>
                                            <span class="badge bg-info">
                                                @(evt.Action == "R" ? "è®€å–" : evt.Action == "C" ? "å»ºç«‹" : evt.Action)
                                            </span>
                                        </td>
                                        <td>@(evt.Agent?.FirstOrDefault()?.Name ?? "Unknown")</td>
                                        <td>
                                            @{
                                                var ip = evt.Agent?.FirstOrDefault()?.Who?.Display ?? "-";
                                            }
                                            <code>@ip</code>
                                        </td>
                                        <td>
                                            @{
                                                var patientRef = evt.Entity?.FirstOrDefault()?.What?.ReferenceValue ?? "-";
                                                var patientName = evt.Entity?.FirstOrDefault()?.Name ?? "";
                                            }
                                            @patientRef
                                            @if (!string.IsNullOrEmpty(patientName))
                                            {
                                                <br/><small class="text-muted">(@patientName)</small>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <p class="text-muted small">å…± @auditEvents.Count ç­†è¨˜éŒ„</p>
                }
                else
                {
                    <div class="text-center py-5">
                        <div style="font-size: 3rem;">ğŸ“­</div>
                        <h4>æš«ç„¡å­˜å–è¨˜éŒ„</h4>
                        <p class="text-muted">ç•¶æ‚¨ç€è¦½ç—…æ‚£è³‡æ–™æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•è¨˜éŒ„å­˜å–äº‹ä»¶</p>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private bool isLoading = false;
    private string? errorMessage;
    private string? fhirBaseUrl;
    private List<AuditEvent>? auditEvents;

    protected override async Task OnInitializedAsync()
    {
        fhirBaseUrl = await AuthService.GetStoredFhirBaseUrlAsync();
        
        if (string.IsNullOrEmpty(fhirBaseUrl))
        {
            errorMessage = "æœªæ‰¾åˆ° FHIR Server URLã€‚è«‹å…ˆé€é /launch å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ã€‚";
            return;
        }

        await LoadAuditEvents();
    }

    private async Task LoadAuditEvents()
    {
        if (string.IsNullOrEmpty(fhirBaseUrl)) return;

        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            auditEvents = await FhirService.GetAuditEventsAsync(fhirBaseUrl);
        }
        catch (Exception ex)
        {
            errorMessage = $"è¼‰å…¥å¤±æ•—: {ex.Message}";
            auditEvents = new List<AuditEvent>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void GoBack()
    {
        nav.NavigateTo("/");
    }

    private string FormatDateTime(string? dateTimeStr)
    {
        if (DateTime.TryParse(dateTimeStr, out var date))
        {
            return date.ToLocalTime().ToString("yyyy/MM/dd HH:mm:ss");
        }
        return dateTimeStr ?? "-";
    }
}
